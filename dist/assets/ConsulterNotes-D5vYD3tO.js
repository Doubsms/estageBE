import{u as fe,r as l,j as e,J as Ee,O as Ae,aY as ge,aZ as Ie,a_ as Se,aM as ye,G as o,z as k,B as I,T as d,v as p,C as S,F as be,K as Ne,A as De,x as Te}from"./index-zHPv1lze.js";import{d as j}from"./dayjs.min-BzR6NVRV.js";import{S as ve}from"./Snackbar-XurLPfxZ.js";import{A as Me}from"./Alert-D6te_eKs.js";import{B as Re}from"./BarChart-CtMQudBV.js";import{F as Oe}from"./FilterList-tzX0eq5I.js";import{A as z}from"./Autocomplete-DkJdCr17.js";import{T as y}from"./TextField-DNVhVnCv.js";import{P as Le}from"./Person-CVTBdQV4.js";import{D as ee}from"./DateRange-tTFtj54i.js";import{F as Ce,S as we}from"./Select-DCG_CkE0.js";import{I as Pe}from"./OutlinedInput-C5vYvqQm.js";import{M as se}from"./MenuItem-D-1uk7AZ.js";import{C as Ue}from"./CalendarToday-BYxDq_1X.js";import{B as te}from"./Button-0T1tR8_c.js";import{C as $e}from"./Close-B5GqWx1j.js";import{D as ke}from"./Download-CCo6S7zV.js";import{C as ze}from"./CircularProgress-BHFhENdB.js";import{T as Fe,a as We,b as qe,c as re,d as i,e as Ye}from"./TableRow-70JfVjDg.js";import{T as Be}from"./TablePagination-Dk7TG7ya.js";const xs=()=>{const u=fe(),[ne,F]=l.useState([]),[f,W]=l.useState([]),[b,q]=l.useState([]),[ae,Y]=l.useState(!1),[x,B]=l.useState({open:!1,message:"",severity:"success"}),[N,V]=l.useState(null),[D,_]=l.useState(null),[T,Q]=l.useState(""),[v,G]=l.useState(null),[M,H]=l.useState(""),[oe,ie]=l.useState([]),[le,J]=l.useState([]),[R,O]=l.useState(0),[E,ce]=l.useState(10),L="",C={headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}},K=(s,t="success")=>{B({open:!0,message:s,severity:t})},Z=(s,t)=>{t!=="clickaway"&&B(r=>({...r,open:!1}))},de=async()=>{Y(!0);try{const s=await fetch(`${L}/listeNotes`,{method:"GET",headers:C.headers});if(s.ok){const t=await s.json();F(Array.isArray(t)?t:[]);const r=new Set;t.forEach(n=>{if(n.DATE_EVALUATION){const a=A(n.DATE_EVALUATION);a&&r.add(a)}});const m=Array.from(r).sort((n,a)=>{const c=parseInt(n.split("-")[0]);return parseInt(a.split("-")[0])-c}).map((n,a)=>({id:a,label:n,value:n}));ie(m)}else throw new Error("Ã‰chec du chargement des notes")}catch(s){console.error("Erreur de chargement des notes:",s),K("Erreur de chargement des notes","error"),F([])}finally{Y(!1)}},me=async()=>{try{const s=await fetch(`${L}/listepersonelformescentreexcellence`,{method:"GET",headers:C.headers});if(s.ok){const t=await s.json();W(Array.isArray(t)?t:[])}}catch(s){console.error("Erreur de chargement des apprenants:",s),W([])}},ue=async()=>{try{const s=await fetch(`${L}/listemodule`,{method:"GET",headers:C.headers});if(s.ok){const t=await s.json();q(Array.isArray(t)?t:[]);const r=new Set;t.forEach(n=>{(n.QUADRIMESTRE1===1||n.QUADRIMESTRE1==="1")&&r.add("S1"),(n.QUADRIMESTRE2===1||n.QUADRIMESTRE2==="1")&&r.add("S2")});const m=Array.from(r).sort().map((n,a)=>({id:a+1,label:n==="S1"?"Semestre 1":"Semestre 2",value:n}));J(m)}}catch(s){console.error("Erreur de chargement des modules:",s),q([]),J([])}},A=s=>{if(!s)return null;const t=j(s).year();return j(s).month()+1>=9?`${t}-${t+1}`:`${t-1}-${t}`},w=s=>{const t=b.find(r=>r.IDMODULE===s);return t?t.QUADRIMESTRE1===1||t.QUADRIMESTRE1==="1"?"S1":t.QUADRIMESTRE2===1||t.QUADRIMESTRE2==="1"?"S2":null:null},P=s=>{const t=f.find(r=>r.IDPERSONNEL===s);return t?`${t.NOM} ${t.PRENOM}${t.NOMMARI?` (${t.NOMMARI})`:""}`:"Inconnu"},U=s=>f.find(r=>r.IDPERSONNEL===s)?.MATRICULE||"N/A",$=s=>b.find(r=>r.IDMODULE===s)?.INTITULE||"Inconnu",h=ne.filter(s=>{let t=!0;if(N&&s.IDMODULE!==N.IDMODULE&&(t=!1),D&&s.IDPERSONNEL!==D.IDPERSONNEL&&(t=!1),v&&A(s.DATE_EVALUATION)!==v.value&&(t=!1),M&&w(s.IDMODULE)!==M&&(t=!1),T){const r=T.toLowerCase(),m=P(s.IDPERSONNEL).toLowerCase(),n=U(s.IDPERSONNEL).toLowerCase(),a=$(s.IDMODULE).toLowerCase();t=t&&(m.includes(r)||n.includes(r)||a.includes(r)||s.NOTE?.toString().includes(r))}return t}),g=(()=>{const s=h.map(a=>parseFloat(a.NOTE)).filter(a=>!isNaN(a));if(s.length===0)return{moyenne:0,min:0,max:0,total:0};const r=s.reduce((a,c)=>a+c,0)/s.length,m=Math.min(...s),n=Math.max(...s);return{moyenne:r.toFixed(2),min:m.toFixed(2),max:n.toFixed(2),total:s.length}})(),xe=(s,t)=>{O(t)},he=s=>{ce(parseInt(s.target.value,10)),O(0)},pe=()=>{V(null),_(null),G(null),H(""),Q(""),O(0)},je=()=>{const s=["Apprenant","Matricule","Module","Note","Date","AnnÃ©e AcadÃ©mique","Semestre","Remarque"],t=h.map(c=>[P(c.IDPERSONNEL),U(c.IDPERSONNEL),$(c.IDMODULE),c.NOTE,j(c.DATE_EVALUATION).format("DD/MM/YYYY"),A(c.DATE_EVALUATION)||"N/A",w(c.IDMODULE)||"N/A",c.REMARQUE||""]),r=[s.join(","),...t.map(c=>c.map(X=>`"${X}"`).join(","))].join(`
`),m=new Blob(["\uFEFF"+r],{type:"text/csv;charset=utf-8"}),n=window.URL.createObjectURL(m),a=document.createElement("a");a.href=n,a.download=`notes_${j().format("YYYY-MM-DD_HH-mm")}.csv`,a.click(),window.URL.revokeObjectURL(n),K(`ðŸ“¥ ${t.length} note(s) exportÃ©e(s) avec succÃ¨s`,"success")};return l.useEffect(()=>{de(),me(),ue()},[]),e.jsxs(Ee.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsx(ve,{open:x.open,autoHideDuration:4e3,onClose:Z,anchorOrigin:{vertical:"top",horizontal:"center"},TransitionComponent:Ae,TransitionProps:{direction:"down"},sx:{mt:"20px",zIndex:9999},children:e.jsx(Me,{onClose:Z,severity:x.severity,sx:{fontWeight:500,fontSize:"1.05rem",borderRadius:2,minWidth:300,textAlign:"center",justifyContent:"center",backgroundColor:x.severity==="success"?"#e8f5e9":x.severity==="error"?"#ffebee":x.severity==="warning"?"#fff8e1":"#e3f2fd",boxShadow:2},iconMapping:{success:e.jsx(ye,{size:24}),error:e.jsx(Se,{size:24}),warning:e.jsx(Ie,{size:24}),info:e.jsx(ge,{size:24})},children:x.message})}),e.jsxs(o,{container:!0,spacing:3,children:[e.jsx(o,{item:!0,xs:12,children:e.jsxs(k,{sx:{p:3,borderRadius:4,boxShadow:u.shadows[3],background:"linear-gradient(45deg, #f5f7fa, #e3e8f0)"},children:[e.jsxs(I,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(d,{variant:"h6",fontWeight:600,display:"flex",alignItems:"center",children:[e.jsx(Re,{sx:{mr:1,color:u.palette.primary.main}}),"Statistiques des notes"]}),e.jsx(p,{label:`${h.length} note(s)`,color:"primary",variant:"outlined"})]}),e.jsxs(o,{container:!0,spacing:2,children:[e.jsx(o,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(S,{sx:{borderRadius:3,textAlign:"center",p:2},children:[e.jsx(d,{variant:"h4",fontWeight:700,color:"primary",children:g.moyenne}),e.jsx(d,{variant:"body2",color:"textSecondary",children:"Moyenne gÃ©nÃ©rale"})]})}),e.jsx(o,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(S,{sx:{borderRadius:3,textAlign:"center",p:2},children:[e.jsx(d,{variant:"h4",fontWeight:700,color:"success.main",children:g.max}),e.jsx(d,{variant:"body2",color:"textSecondary",children:"Note maximale"})]})}),e.jsx(o,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(S,{sx:{borderRadius:3,textAlign:"center",p:2},children:[e.jsx(d,{variant:"h4",fontWeight:700,color:"error.main",children:g.min}),e.jsx(d,{variant:"body2",color:"textSecondary",children:"Note minimale"})]})}),e.jsx(o,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(S,{sx:{borderRadius:3,textAlign:"center",p:2},children:[e.jsx(d,{variant:"h4",fontWeight:700,color:"info.main",children:g.total}),e.jsx(d,{variant:"body2",color:"textSecondary",children:"Total notes"})]})})]})]})}),e.jsx(o,{item:!0,xs:12,children:e.jsxs(k,{sx:{p:3,borderRadius:4,boxShadow:u.shadows[3],borderLeft:`5px solid ${u.palette.primary.main}`},children:[e.jsxs(I,{display:"flex",alignItems:"center",mb:2,children:[e.jsx(Oe,{sx:{mr:1,color:u.palette.primary.main}}),e.jsx(d,{variant:"h6",fontWeight:600,children:"Filtres de recherche"})]}),e.jsxs(o,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(o,{item:!0,xs:12,md:3,children:e.jsx(z,{options:b,getOptionLabel:s=>s.INTITULE||"",value:N,onChange:(s,t)=>V(t),renderInput:s=>e.jsx(y,{...s,label:"Module",variant:"outlined",size:"small",InputProps:{...s.InputProps,startAdornment:e.jsx(be,{sx:{color:"action.active",mr:1}})}}),noOptionsText:"Aucun module"})}),e.jsx(o,{item:!0,xs:12,md:3,children:e.jsx(z,{options:f,getOptionLabel:s=>`${s.NOM} ${s.PRENOM}${s.NOMMARI?` (${s.NOMMARI})`:""}`||"",value:D,onChange:(s,t)=>_(t),renderInput:s=>e.jsx(y,{...s,label:"Apprenant",variant:"outlined",size:"small",InputProps:{...s.InputProps,startAdornment:e.jsx(Le,{sx:{color:"action.active",mr:1}})}}),noOptionsText:"Aucun apprenant"})}),e.jsx(o,{item:!0,xs:12,md:3,children:e.jsx(z,{options:oe,getOptionLabel:s=>s.label||"",value:v,onChange:(s,t)=>G(t),renderInput:s=>e.jsx(y,{...s,label:"AnnÃ©e AcadÃ©mique",variant:"outlined",size:"small",InputProps:{...s.InputProps,startAdornment:e.jsx(ee,{sx:{color:"action.active",mr:1}})}}),noOptionsText:"Aucune annÃ©e"})}),e.jsx(o,{item:!0,xs:12,md:3,children:e.jsxs(Ce,{fullWidth:!0,size:"small",children:[e.jsx(Pe,{id:"semestre-label",children:"Semestre"}),e.jsxs(we,{labelId:"semestre-label",value:M,onChange:s=>H(s.target.value),label:"Semestre",startAdornment:e.jsx(Ue,{sx:{color:"action.active",mr:1}}),children:[e.jsx(se,{value:"",children:"Tous les semestres"}),le.map(s=>e.jsx(se,{value:s.value,children:s.label},s.id))]})]})}),e.jsx(o,{item:!0,xs:12,md:6,children:e.jsx(y,{fullWidth:!0,size:"small",label:"Recherche",value:T,onChange:s=>Q(s.target.value),placeholder:"Nom, prÃ©nom, matricule, module, note...",InputProps:{startAdornment:e.jsx(Ne,{sx:{color:"action.active",mr:1}})}})}),e.jsxs(o,{item:!0,xs:12,md:6,display:"flex",justifyContent:"flex-end",gap:2,children:[e.jsx(te,{variant:"outlined",startIcon:e.jsx($e,{}),onClick:pe,children:"RÃ©initialiser"}),e.jsx(te,{variant:"contained",startIcon:e.jsx(ke,{}),onClick:je,children:"Exporter CSV"})]})]})]})}),e.jsx(o,{item:!0,xs:12,children:e.jsx(k,{sx:{p:3,borderRadius:4,boxShadow:u.shadows[3],display:"flex",flexDirection:"column"},children:ae?e.jsx(I,{display:"flex",justifyContent:"center",alignItems:"center",height:300,children:e.jsx(ze,{size:60})}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{children:e.jsxs(We,{stickyHeader:!0,children:[e.jsx(qe,{children:e.jsxs(re,{children:[e.jsx(i,{children:"Apprenant"}),e.jsx(i,{children:"Matricule"}),e.jsx(i,{children:"Module"}),e.jsx(i,{align:"center",children:"Note"}),e.jsx(i,{children:"Date"}),e.jsx(i,{children:"AnnÃ©e Acad."}),e.jsx(i,{children:"Semestre"}),e.jsx(i,{children:"Remarque"})]})}),e.jsx(Ye,{children:h.slice(R*E,R*E+E).map(s=>{const t=f.find(r=>r.IDPERSONNEL===s.IDPERSONNEL);return e.jsxs(re,{hover:!0,children:[e.jsx(i,{children:e.jsxs(I,{display:"flex",alignItems:"center",children:[e.jsx(De,{sx:{width:32,height:32,mr:2,bgcolor:u.palette.primary.light},children:t?.NOM?.charAt(0)||"?"}),e.jsx(d,{variant:"body2",fontWeight:500,children:P(s.IDPERSONNEL)})]})}),e.jsx(i,{children:e.jsx(p,{label:U(s.IDPERSONNEL),size:"small",variant:"outlined"})}),e.jsx(i,{children:e.jsx(d,{variant:"body2",children:$(s.IDMODULE)})}),e.jsx(i,{align:"center",children:e.jsx(p,{label:s.NOTE,color:s.NOTE>=16?"success":s.NOTE>=12?"primary":s.NOTE>=8?"warning":"error",size:"small",sx:{fontWeight:"bold",minWidth:50}})}),e.jsx(i,{children:e.jsx(d,{variant:"body2",children:j(s.DATE_EVALUATION).format("DD/MM/YYYY")})}),e.jsx(i,{children:e.jsx(p,{label:A(s.DATE_EVALUATION)||"N/A",size:"small",variant:"outlined",icon:e.jsx(ee,{fontSize:"small"})})}),e.jsx(i,{children:e.jsx(p,{label:w(s.IDMODULE)||"N/A",size:"small",color:"primary",variant:"outlined"})}),e.jsx(i,{children:e.jsx(Te,{title:s.APPRECIATION||"Aucune remarque",children:e.jsx(d,{variant:"body2",sx:{maxWidth:150,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",cursor:"help"},children:s.APPRECIATION||"-"})})})]},s.IDNOTE||s.IDPERSONNEL+s.IDMODULE+s.DATE_EVALUATION)})})]})}),e.jsx(Be,{rowsPerPageOptions:[5,10,25,50,100],component:"div",count:h.length,rowsPerPage:E,page:R,onPageChange:xe,onRowsPerPageChange:he,labelRowsPerPage:"Lignes par page:",labelDisplayedRows:({from:s,to:t,count:r})=>`${s}-${t} sur ${r}`,sx:{mt:2}})]})})})]})]})};export{xs as C};
