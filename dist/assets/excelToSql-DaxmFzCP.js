import{l as re,j as e,r as p,B as g,C as Q,w as M,T as b,G as x,L as se,D as ne,z as oe,x as ie,I as ae}from"./index-zHPv1lze.js";import{r as le,u as ce}from"./xlsx-tiLM45nF.js";import{A as k}from"./Alert-D6te_eKs.js";import{T as W}from"./TextField-DNVhVnCv.js";import{B as w}from"./Button-0T1tR8_c.js";import{U as de}from"./CloudUpload-Cg5Zj6Ic.js";import{D as ue}from"./Delete-DRqEtRSt.js";import{T as he,a as pe,b as xe,c as G,d as E,e as me}from"./TableRow-70JfVjDg.js";import{D as fe}from"./Download-CCo6S7zV.js";import"./Close-DS868zx3.js";import"./OutlinedInput-C5vYvqQm.js";import"./useFormControl-BwsGWz84.js";import"./Select-DCG_CkE0.js";import"./FormHelperText-BXMwkblB.js";import"./ButtonGroupButtonContext-BYVHV5Ft.js";const je=re(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"}),"ContentCopy"),Fe=()=>{const[z,O]=p.useState(null),[c,R]=p.useState(""),[d,V]=p.useState(""),[v,C]=p.useState([]),[q,u]=p.useState(""),[P,I]=p.useState(!1),[i,$]=p.useState(null),[T,m]=p.useState(""),H=(t,r)=>{const o=new Date(t),n=new Date(r);let s=0;for(let h=new Date(o);h<=n;h.setDate(h.getDate()+1)){const a=h.getDay();a>=1&&a<=5&&s++}return s},A=(t,r,o)=>{if(!r||!o)throw new Error("Veuillez sélectionner la période (date début et date fin)");if(new Date(r)>new Date(o))throw new Error("La date de début doit être avant la date de fin");const n=H(r,o),s=n*2,a=t[0].slice(2);if(a.length!==s)throw new Error(`Incohérence détectée: Le fichier contient ${a.length} périodes mais la période sélectionnée (${r} à ${o}) a ${n} jours ouvrés soit ${s} périodes attendues`);return{joursOuvres:n,periodesAttendues:s,presenceColumns:a}},_=t=>{const r=t.target.files[0];if(!r)return;if(!r.name.match(/\.(xlsx|xls)$/)){u("Veuillez sélectionner un fichier Excel (.xlsx ou .xls)");return}O(r),u(""),C([]),$(null),m("");const o=new FileReader;o.onload=n=>{try{I(!0);const s=new Uint8Array(n.target.result),h=le(s,{type:"array"}),a=h.SheetNames[0],f=h.Sheets[a],j=ce.sheet_to_json(f,{header:1});if(j.length<2)throw new Error("Le fichier Excel semble vide ou ne contient pas de données");if($(j),c&&d)try{const l=A(j,c,d);m(`✅ Fichier valide: ${l.presenceColumns.length} périodes détectées, correspondant à ${l.joursOuvres} jours ouvrés`)}catch(l){m(`❌ ${l.message}`)}}catch(s){u("Erreur lors de la lecture du fichier: "+s.message)}finally{I(!1)}},o.onerror=()=>{u("Erreur lors de la lecture du fichier"),I(!1)},o.readAsArrayBuffer(r)},K=()=>{try{if(u(""),C([]),!i){u("Veuillez d'abord téléverser un fichier Excel");return}if(!c||!d){u("Veuillez sélectionner la période (date début et date fin)");return}const t=A(i,c,d),{joursOuvres:r,presenceColumns:o}=t,n=[],s=new Date(c),h=new Date(d);for(;s<=h;){const f=s.getDay();f>=1&&f<=5&&n.push(new Date(s)),s.setDate(s.getDate()+1)}const a=[];if(n.forEach((f,j)=>{const l=f.toISOString().split("T")[0],B=j*2,Z=j*2+1,D=[],S=[];for(let L=1;L<i.length;L++){const y=i[L];if(y.length>=2+B+1){const N=y[0]?.toString().trim(),F=y[1]?.toString().trim(),ee=parseInt(y[2+B])||0,te=parseInt(y[2+Z])||0;N&&F&&(ee===1&&D.push(`('${N}', '${F.replace(/'/g,"''")}', '${l} 14:00:00.000000', '${l}', '14:00:00.000000', '', 'Terminal2', 'DS-K1A802AEF20230223V010400ENAA8727585', 0)`),te===1&&S.push(`('${N}', '${F.replace(/'/g,"''")}', '${l} 17:00:00.000000', '${l}', '17:00:00.000000', '', 'Terminal2', 'DS-K1A802AEF20230223V010400ENAA8727585', 0)`))}}D.length>0&&a.push({title:`${l} - Période du matin (14h00) - ${D.length} présences`,query:`INSERT INTO \`presencecentreexcellence\` (\`employeeID\`, \`personName\`, \`authDateTime\`, \`authDate\`, \`authTime\`, \`direction\`, \`deviceName\`, \`deviceSN\`, \`cardNo\`) VALUES
${D.join(`,
`)};`}),S.length>0&&a.push({title:`${l} - Période de l'après-midi (17h00) - ${S.length} présences`,query:`INSERT INTO \`presencecentreexcellence\` (\`employeeID\`, \`personName\`, \`authDateTime\`, \`authDate\`, \`authTime\`, \`direction\`, \`deviceName\`, \`deviceSN\`, \`cardNo\`) VALUES
${S.join(`,
`)};`})}),a.length===0){u("Aucune présence détectée dans le fichier pour la période sélectionnée");return}C(a)}catch(t){u("Erreur lors de la génération des requêtes: "+t.message)}},U=()=>{if(i&&c&&d)try{const t=A(i,c,d);m(`✅ Fichier valide: ${t.presenceColumns.length} périodes détectées, correspondant à ${t.joursOuvres} jours ouvrés`)}catch(t){m(`❌ ${t.message}`)}},J=t=>{navigator.clipboard.writeText(t)},X=()=>{const t=v.map(s=>`-- ${s.title}
${s.query}`).join(`

`),r=new Blob([t],{type:"text/sql"}),o=URL.createObjectURL(r),n=document.createElement("a");n.href=o,n.download=`presences_${c}_${d}.sql`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o)},Y=()=>{O(null),$(null),R(""),V(""),C([]),u(""),m("");const t=document.getElementById("excel-file-input");t&&(t.value="")};return e.jsx(g,{sx:{p:3},children:e.jsx(Q,{elevation:3,children:e.jsxs(M,{children:[e.jsx(b,{variant:"h4",gutterBottom:!0,color:"primary",children:"Générateur SQL depuis Excel"}),e.jsxs(k,{severity:"info",sx:{mb:3},children:["Téléversez un fichier Excel contenant les présences. Structure attendue :",e.jsx("br",{}),"• Colonne 1: ID Employé",e.jsx("br",{}),"• Colonne 2: Nom Complet",e.jsx("br",{}),"• Colonnes suivantes: Présences (1 = présent, 0 = absent) dans l'ordre chronologique"]}),q&&e.jsx(k,{severity:"error",sx:{mb:2},children:q}),e.jsxs(x,{container:!0,spacing:3,children:[e.jsx(x,{item:!0,xs:12,md:6,children:e.jsx(W,{label:"Date de début",type:"date",value:c,onChange:t=>{R(t.target.value),setTimeout(U,100)},fullWidth:!0,InputLabelProps:{shrink:!0}})}),e.jsx(x,{item:!0,xs:12,md:6,children:e.jsx(W,{label:"Date de fin",type:"date",value:d,onChange:t=>{V(t.target.value),setTimeout(U,100)},fullWidth:!0,InputLabelProps:{shrink:!0}})}),e.jsxs(x,{item:!0,xs:12,children:[e.jsxs(g,{sx:{border:"2px dashed",borderColor:"grey.300",borderRadius:2,p:3,textAlign:"center",backgroundColor:"grey.50","&:hover":{borderColor:"primary.main",backgroundColor:"grey.100"}},children:[e.jsx("input",{id:"excel-file-input",type:"file",accept:".xlsx,.xls",onChange:_,style:{display:"none"}}),e.jsx("label",{htmlFor:"excel-file-input",children:e.jsx(w,{variant:"outlined",component:"span",startIcon:e.jsx(de,{}),sx:{mb:1},children:"Choisir le fichier Excel"})}),z&&e.jsxs(g,{sx:{mt:1},children:[e.jsxs(b,{variant:"body2",color:"success.main",children:["✓ ",z.name]}),e.jsx(w,{size:"small",startIcon:e.jsx(ue,{}),onClick:Y,color:"error",children:"Supprimer"})]}),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Formats supportés: .xlsx, .xls"})]}),P&&e.jsx(se,{sx:{mt:2}})]}),T&&e.jsx(x,{item:!0,xs:12,children:e.jsx(k,{severity:T.includes("❌")?"error":"success",sx:{mb:2},children:T})}),i&&i.length>0&&e.jsx(x,{item:!0,xs:12,children:e.jsx(Q,{variant:"outlined",children:e.jsxs(M,{children:[e.jsxs(b,{variant:"h6",gutterBottom:!0,children:["Aperçu du fichier (",i.length-1," apprenants)"]}),e.jsx(he,{sx:{maxHeight:200},children:e.jsxs(pe,{size:"small",stickyHeader:!0,children:[e.jsx(xe,{children:e.jsxs(G,{children:[i[0].slice(0,6).map((t,r)=>e.jsx(E,{sx:{fontWeight:"bold"},children:t},r)),i[0].length>6&&e.jsxs(E,{sx:{fontWeight:"bold"},children:["... (+",i[0].length-6," colonnes)"]})]})}),e.jsx(me,{children:i.slice(1,6).map((t,r)=>e.jsxs(G,{children:[t.slice(0,6).map((o,n)=>e.jsx(E,{children:o},n)),t.length>6&&e.jsx(E,{children:"..."})]},r))})]})})]})})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(w,{variant:"contained",onClick:K,size:"large",fullWidth:!0,sx:{py:1.5},disabled:!i||!c||!d||P,children:"Générer les requêtes SQL"})})]}),v.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(ne,{sx:{my:3}}),e.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(b,{variant:"h5",children:["Requêtes générées (",v.length," périodes)"]}),e.jsx(w,{variant:"outlined",onClick:X,startIcon:e.jsx(fe,{}),children:"Télécharger SQL"})]}),v.map((t,r)=>e.jsxs(oe,{elevation:2,sx:{p:2,mb:2,backgroundColor:"#f8f9fa"},children:[e.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(b,{variant:"h6",color:"primary",children:t.title}),e.jsx(ie,{title:"Copier la requête",children:e.jsx(ae,{onClick:()=>J(t.query),color:"primary",size:"small",children:e.jsx(je,{})})})]}),e.jsx(g,{component:"pre",sx:{p:2,backgroundColor:"#2d2d2d",color:"#f8f8f2",borderRadius:1,overflow:"auto",fontSize:"0.85rem",fontFamily:'Monaco, Consolas, "Courier New", monospace'},children:t.query})]},r))]})]})})})};export{Fe as default};
