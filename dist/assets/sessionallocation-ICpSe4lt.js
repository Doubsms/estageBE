import{l as Oe,j as e,r as o,z as ye,B as l,T as t,D as Re,G as p,F as X,C as ie,w as Z,s as le,v as Te,I as ee,K as se,Z as De}from"./index-zHPv1lze.js";import{a as T}from"./index-C3O71W1x.js";import{d as ve}from"./debounce-CEXHgCrW.js";import{L as Ce}from"./LocalizationProvider-DMHyi95E.js";import{f as Pe,A as Ae}from"./fr-BqwbHVGE.js";import{A as Le}from"./Autocomplete-DkJdCr17.js";import{T as re}from"./TextField-DNVhVnCv.js";import{C as D}from"./CircularProgress-BHFhENdB.js";import{I as te}from"./InputAdornment-BgDE6Kz5.js";import{Q as Fe,E as ne}from"./QueryStats-CBn45aSn.js";import{G as ke}from"./Groups-DO3ZmRBj.js";import{S as we}from"./Schedule-WrpPNihg.js";import{C as ze}from"./CalendarToday-BYxDq_1X.js";import{a as Me,D as Ue}from"./DialogContent-COvIddmc.js";import{D as Be}from"./DialogTitle-CCgKuUmv.js";import{C as oe}from"./Close-B5GqWx1j.js";import{F as ae}from"./FormControlLabel-D_GYa5-T.js";import{C as v}from"./Checkbox-BNRiEFgI.js";import{T as We,a as $e,b as Ge,c as L,d as h,e as He}from"./TableRow-70JfVjDg.js";import{P as qe}from"./People-RwhYgLWm.js";import{D as Je}from"./DialogActions-CZ9LuKoL.js";import{B as k}from"./Button-0T1tR8_c.js";import{D as Ve}from"./Delete-DRqEtRSt.js";import{S as Ye}from"./Snackbar-XurLPfxZ.js";import{A as Qe}from"./Alert-D6te_eKs.js";import"./Select-DCG_CkE0.js";import"./OutlinedInput-C5vYvqQm.js";import"./useFormControl-BwsGWz84.js";import"./Close-DS868zx3.js";import"./FormHelperText-BXMwkblB.js";import"./SwitchBase-CEgujy3G.js";import"./ButtonGroupButtonContext-BYVHV5Ft.js";const F=Oe(e.jsx("path",{d:"M14 8c0-2.21-1.79-4-4-4S6 5.79 6 8s1.79 4 4 4 4-1.79 4-4m3 2v2h6v-2zM2 18v2h16v-2c0-2.66-5.33-4-8-4s-8 1.34-8 4"}),"PersonRemove"),_e=De.forwardRef(function(j,c){return e.jsx(Qe,{elevation:6,ref:c,...j})}),Ke=le(k)(({theme:g})=>({background:"linear-gradient(135deg, #f44336 0%, #c62828 100%)",color:"white",borderRadius:"25px",padding:g.spacing(1,3),fontWeight:"bold",textTransform:"none",boxShadow:"0 4px 12px rgba(244, 67, 54, 0.3)","&:hover":{background:"linear-gradient(135deg, #e53935 0%, #b71c1c 100%)",boxShadow:"0 6px 16px rgba(244, 67, 54, 0.4)"}})),Xe=le(ie)(({theme:g,selected:j})=>({border:j?"2px solid #f44336":"1px solid #e0e0e0",borderRadius:"12px",cursor:"pointer",transition:"all 0.3s ease",background:j?"linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)":"white","&:hover":{transform:"translateY(-2px)",boxShadow:"0 6px 20px rgba(0, 0, 0, 0.1)"}})),Ps=()=>{const[g,j]=o.useState([]),[c,ce]=o.useState(null),[C,w]=o.useState([]),[f,y]=o.useState(null),[d,de]=o.useState([]),[i,m]=o.useState([]),[x,P]=o.useState([]),[u,I]=o.useState(""),[A,z]=o.useState(!1),[M,U]=o.useState(!1),[B,W]=o.useState(!1),[xe,$]=o.useState(!1),[pe,b]=o.useState(!1),[he,G]=o.useState(!1),[me,ue]=o.useState(""),[Se,fe]=o.useState("success"),[H,ge]=o.useState(""),[je,Ie]=o.useState(""),N="",O=localStorage.getItem("token"),q=o.useCallback(ve(async s=>{U(!0);try{const r=await T.get(`${N}/listeformationeffectuees`,{headers:{Authorization:`Bearer ${O}`},params:{search:s}});j(r.data||[])}catch{E("Erreur lors du chargement des formations","error")}finally{U(!1)}},300),[N,O]),J=async s=>{if(s){W(!0);try{const r=`
        SELECT 
          s.IDSESSION,
          s.DATE,
          f.INTITULE as FormationIntitule,
          COUNT(DISTINCT ps.IDPERSONNEL) as NombreParticipants
        FROM sessionformation s
        LEFT JOIN formationmodifiable f ON s.IDFORMATION = f.IDFORMATIONM
        LEFT JOIN participer_session ps ON s.IDSESSION = ps.IDSESSION
        WHERE s.IDFORMATION = ${s}
        GROUP BY s.IDSESSION, s.DATE, f.INTITULE
        ORDER BY s.DATE DESC;
      `,a=await T.post(`${N}/personnaliserrequette`,{query:r},{headers:{Authorization:`Bearer ${O}`}});w(a.data||[])}catch{E("Erreur lors du chargement des sessions","error")}finally{W(!1)}}},V=async s=>{if(s){$(!0);try{const r=`
        SELECT 
          p.IDPERSONNEL,
          p.MATRICULE,
          p.NOM,
          p.PRENOM,
          p.FONCTION,
          p.TELEPHONE,
          p.GRADE,
          p.SEXE,
          COALESCE(s.NOMSTRUCTURE, 'Non spécifié') as Structure,
          COALESCE(s.ABBREVIATION, 'N/A') as StructureAbbreviation
        FROM personel p
        LEFT JOIN structure s ON p.IDSTRUCTURE = s.IDSTRUCTURE
        JOIN participer_session ps ON p.IDPERSONNEL = ps.IDPERSONNEL
        WHERE ps.IDSESSION = ${s}
        ORDER BY s.NOMSTRUCTURE, p.NOM, p.PRENOM;
      `,n=(await T.post(`${N}/personnaliserrequette`,{query:r},{headers:{Authorization:`Bearer ${O}`}})).data||[];de(n),P(n)}catch{E("Erreur lors du chargement des participants","error")}finally{$(!1)}}};o.useEffect(()=>{q(H)},[H,q]),o.useEffect(()=>{c?(J(c.IDFORMATIONM),y(null)):(w([]),y(null))},[c]),o.useEffect(()=>{if(u.trim()==="")P(d);else{const s=u.toLowerCase(),r=d.filter(a=>{const n=S=>S?S.toString().toLowerCase():"";return n(a.NOM).includes(s)||n(a.PRENOM).includes(s)||n(a.MATRICULE).includes(s)||n(a.Structure).includes(s)||n(a.FONCTION).includes(s)});P(r)}},[u,d]);const Y=s=>{const r=i.some(a=>a.IDPERSONNEL===s.IDPERSONNEL);m(r?a=>a.filter(n=>n.IDPERSONNEL!==s.IDPERSONNEL):a=>[...a,s])},Ee=()=>{const s=new Set(x.map(n=>n.IDPERSONNEL)),r=new Set(i.map(n=>n.IDPERSONNEL));if(x.every(n=>r.has(n.IDPERSONNEL)))m(n=>n.filter(S=>!s.has(S.IDPERSONNEL)));else{const n=x.filter(S=>!r.has(S.IDPERSONNEL));m(S=>[...S,...n])}},Q=()=>{const s=new Set(d.map(n=>n.IDPERSONNEL)),r=new Set(i.map(n=>n.IDPERSONNEL)),a=d.length>0&&r.size===s.size;m(a?[]:[...d])},be=async()=>{if(!f||i.length===0){E("Veuillez sélectionner au moins un participant à supprimer","error");return}z(!0);try{for(const s of i)if((await T.post(`${N}/supprimerparticipation`,{IDPERSONNEL:s.IDPERSONNEL,IDSESSION:f.IDSESSION},{headers:{Authorization:`Bearer ${O}`,"Content-Type":"application/json"}})).status!==200)throw new Error("Erreur lors de la suppression");E(`${i.length} participant(s) supprimé(s) de la session avec succès`,"success"),b(!1),m([]),I(""),c&&(J(c.IDFORMATIONM),V(f.IDSESSION))}catch(s){console.error("Erreur détaillée :",s);const r=s.response?.data?.message||"Erreur lors de la suppression des participants";E(r,"error")}finally{z(!1)}},E=(s,r)=>{ue(s),fe(r),G(!0)},_=()=>G(!1),R=s=>s?new Date(s).toLocaleDateString("fr-FR"):"-",K=()=>{if(x.length===0)return!1;const s=new Set(i.map(r=>r.IDPERSONNEL));return x.every(r=>s.has(r.IDPERSONNEL))},Ne=()=>{if(x.length===0)return!1;const s=new Set(i.map(r=>r.IDPERSONNEL));return x.some(r=>s.has(r.IDPERSONNEL))};return e.jsx(Ce,{dateAdapter:Ae,adapterLocale:Pe,children:e.jsxs(ye,{elevation:0,sx:{p:4,maxWidth:1200,mx:"auto",borderRadius:3,bgcolor:"background.paper",boxShadow:"0px 4px 20px rgba(0, 0, 0, 0.05)"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(F,{color:"error",sx:{fontSize:36,mr:2}}),e.jsxs(l,{children:[e.jsx(t,{variant:"h5",fontWeight:"bold",color:"error",children:"Suppression des Participants aux Sessions"}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Retirez des participants des sessions de formation"})]})]}),e.jsx(Re,{sx:{my:3}}),e.jsxs(p,{container:!0,spacing:3,children:[e.jsx(p,{item:!0,xs:12,md:6,children:e.jsx(Le,{fullWidth:!0,options:g,getOptionLabel:s=>s?.INTITULE||"",value:c,onChange:(s,r)=>{ce(r),y(null)},inputValue:je,onInputChange:(s,r)=>{Ie(r),ge(r)},loading:M,renderInput:s=>e.jsx(re,{...s,label:"Sélectionner une formation",variant:"outlined",placeholder:"Rechercher une formation...",InputProps:{...s.InputProps,startAdornment:e.jsxs(e.Fragment,{children:[e.jsx(te,{position:"start",children:e.jsx(X,{color:"action"})}),s.InputProps.startAdornment]}),endAdornment:M?e.jsx(D,{color:"inherit",size:20}):null},sx:{bgcolor:"#f9f9f9"}}),renderOption:(s,r)=>e.jsxs(l,{component:"li",...s,children:[e.jsx(X,{sx:{mr:2,color:"action.active"}}),e.jsxs(l,{children:[e.jsx(t,{children:r.INTITULE}),r.DATE&&e.jsxs(t,{variant:"body2",color:"text.secondary",children:["Date: ",R(r.DATE)]})]})]}),noOptionsText:"Aucune formation trouvée",loadingText:"Chargement des formations..."})}),e.jsx(p,{item:!0,xs:12,md:6,children:e.jsx(ie,{sx:{bgcolor:"#fff5f5",border:"1px solid #ffcdd2"},children:e.jsxs(Z,{children:[e.jsxs(t,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Fe,{sx:{mr:1}}),"Statistiques"]}),e.jsxs(p,{container:!0,spacing:2,children:[e.jsxs(p,{item:!0,xs:6,children:[e.jsx(t,{variant:"body2",color:"text.secondary",children:"Formations chargées"}),e.jsx(t,{variant:"h6",color:"error",children:g.length})]}),e.jsxs(p,{item:!0,xs:6,children:[e.jsx(t,{variant:"body2",color:"text.secondary",children:"Sessions disponibles"}),e.jsx(t,{variant:"h6",color:"error",children:C.length})]})]}),c&&e.jsx(l,{sx:{mt:2,p:1,bgcolor:"#ffebee",borderRadius:1},children:e.jsxs(t,{variant:"body2",color:"error",sx:{display:"flex",alignItems:"center"},children:[e.jsx(ke,{sx:{mr:1,fontSize:16}}),c.INTITULE]})})]})})})]}),c&&e.jsxs(l,{sx:{mt:3},children:[e.jsxs(t,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(we,{sx:{mr:1}}),"Sessions disponibles pour ",c.INTITULE,B&&e.jsx(D,{size:20,sx:{ml:2}})]}),e.jsxs(p,{container:!0,spacing:2,children:[C.map(s=>e.jsx(p,{item:!0,xs:12,md:6,lg:4,children:e.jsx(Xe,{selected:f?.IDSESSION===s.IDSESSION,onClick:()=>{y(s),V(s.IDSESSION),b(!0)},children:e.jsxs(Z,{children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2},children:[e.jsxs(t,{variant:"h6",sx:{fontSize:"1rem",fontWeight:"bold"},children:["Session #",s.IDSESSION]}),e.jsx(Te,{label:`${s.NombreParticipants||0} participants`,size:"small",color:"error",variant:"outlined"})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(ze,{sx:{mr:1,fontSize:16,color:"text.secondary"}}),e.jsx(t,{variant:"body2",children:R(s.DATE)})]}),e.jsx(t,{variant:"body2",color:"text.secondary",sx:{mb:2},children:c.INTITULE}),e.jsx(Ke,{fullWidth:!0,startIcon:e.jsx(F,{}),disabled:s.NombreParticipants===0,children:"Gérer les participants"})]})})},s.IDSESSION)),C.length===0&&!B&&e.jsx(p,{item:!0,xs:12,children:e.jsxs(l,{sx:{textAlign:"center",py:4},children:[e.jsx(ne,{sx:{fontSize:48,color:"text.disabled",mb:2}}),e.jsx(t,{variant:"h6",color:"text.secondary",children:"Aucune session trouvée pour cette formation"})]})})]})]}),e.jsxs(Me,{open:pe,onClose:()=>{b(!1),m([]),I("")},fullWidth:!0,maxWidth:"lg",PaperProps:{sx:{borderRadius:3,boxShadow:"0px 8px 24px rgba(0, 0, 0, 0.1)"}},children:[e.jsxs(Be,{sx:{bgcolor:"#fff5f5",color:"text.primary",display:"flex",justifyContent:"space-between",alignItems:"center",py:2,pr:2,borderBottom:"1px solid #e0e0e0"},children:[e.jsxs(l,{display:"flex",alignItems:"center",children:[e.jsx(F,{sx:{mr:1.5,fontSize:28,color:"error.main"}}),e.jsxs(l,{children:[e.jsx(t,{variant:"h6",fontWeight:"medium",children:"Supprimer des Participants de la Session"}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:["Session #",f?.IDSESSION," - ",R(f?.DATE)]}),e.jsxs(t,{variant:"body2",color:"error",sx:{mt:.5},children:[d.length," participant(s) actuellement dans cette session"]})]})]}),e.jsx(ee,{onClick:()=>{b(!1),m([]),I("")},size:"small",sx:{color:"text.secondary"},children:e.jsx(oe,{})})]}),e.jsxs(Ue,{sx:{py:3},children:[e.jsx(l,{sx:{mb:3,p:2,bgcolor:"#fff5f5",borderRadius:2},children:e.jsxs(p,{container:!0,spacing:2,alignItems:"center",children:[e.jsxs(p,{item:!0,xs:12,md:6,children:[e.jsx(t,{variant:"subtitle1",fontWeight:"bold",children:c?.INTITULE}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:["Session du ",R(f?.DATE)]})]}),e.jsx(p,{item:!0,xs:12,md:6,children:e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(t,{variant:"body2",children:[e.jsx("strong",{children:i.length})," participant(s) sélectionné(s) pour suppression"]}),d.length>0&&e.jsx(ae,{control:e.jsx(v,{checked:i.length===d.length,indeterminate:i.length>0&&i.length<d.length,onChange:Q}),label:"Tous"})]})})]})}),xe?e.jsx(l,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(D,{})}):d.length>0?e.jsxs(e.Fragment,{children:[e.jsx(re,{fullWidth:!0,variant:"outlined",placeholder:"Rechercher un participant (nom, prénom, matricule, structure...)",value:u,onChange:s=>I(s.target.value),InputProps:{startAdornment:e.jsx(te,{position:"start",children:e.jsx(se,{color:"action"})}),endAdornment:u&&e.jsx(ee,{size:"small",onClick:()=>I(""),children:e.jsx(oe,{fontSize:"small"})})},sx:{mb:3}}),e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(t,{variant:"body2",color:"text.secondary",children:[x.length," participant(s) trouvé(s)",u&&` pour "${u}"`]}),x.length>0&&e.jsx(ae,{control:e.jsx(v,{checked:K(),indeterminate:Ne()&&!K(),onChange:Ee}),label:`Sélectionner les ${x.length} trouvé(s)`})]}),e.jsx(We,{sx:{maxHeight:400,border:"1px solid #e0e0e0",borderRadius:1},children:e.jsxs($e,{stickyHeader:!0,size:"small",children:[e.jsx(Ge,{children:e.jsxs(L,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(v,{checked:i.length===d.length,indeterminate:i.length>0&&i.length<d.length,onChange:Q})}),e.jsx(h,{children:"Nom & Prénom"}),e.jsx(h,{children:"Matricule"}),e.jsx(h,{children:"Structure"}),e.jsx(h,{children:"Fonction"})]})}),e.jsx(He,{children:x.length>0?x.map(s=>{const r=i.some(a=>a.IDPERSONNEL===s.IDPERSONNEL);return e.jsxs(L,{hover:!0,selected:r,onClick:()=>Y(s),sx:{cursor:"pointer"},children:[e.jsx(h,{padding:"checkbox",onClick:a=>a.stopPropagation(),children:e.jsx(v,{checked:r,onChange:()=>Y(s)})}),e.jsx(h,{children:e.jsxs(t,{variant:"body2",fontWeight:"medium",children:[s.PRENOM||""," ",s.NOM||""]})}),e.jsx(h,{children:s.MATRICULE||"N/A"}),e.jsx(h,{children:s.Structure||"Non spécifié"}),e.jsx(h,{children:s.FONCTION||"Non spécifié"})]},s.IDPERSONNEL)}):e.jsx(L,{children:e.jsxs(h,{colSpan:5,align:"center",sx:{py:4},children:[e.jsx(se,{sx:{fontSize:48,color:"text.disabled",mb:2}}),e.jsxs(t,{variant:"body1",color:"text.secondary",children:['Aucun participant trouvé pour "',u,'"']})]})})})]})}),i.length>0&&e.jsx(l,{sx:{mt:3,p:2,bgcolor:"#ffebee",borderRadius:2},children:e.jsxs(t,{variant:"body2",color:"error",sx:{display:"flex",alignItems:"center"},children:[e.jsx(ne,{sx:{mr:1,fontSize:16}}),e.jsx("strong",{children:"Attention:"})," ",i.length," participant(s) seront retirés de la session"]})})]}):e.jsxs(l,{sx:{textAlign:"center",py:4},children:[e.jsx(qe,{sx:{fontSize:48,color:"text.disabled",mb:2}}),e.jsx(t,{variant:"h6",color:"text.secondary",children:"Aucun participant dans cette session"}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Cette session ne contient actuellement aucun participant"})]})]}),e.jsxs(Je,{sx:{px:3,py:2,borderTop:"1px solid #e0e0e0"},children:[e.jsx(k,{onClick:()=>{b(!1),m([]),I("")},children:"Annuler"}),e.jsx(k,{variant:"contained",startIcon:A?e.jsx(D,{size:20}):e.jsx(Ve,{}),onClick:be,disabled:A||i.length===0||d.length===0,sx:{background:"linear-gradient(135deg, #f44336 0%, #c62828 100%)","&:hover":{background:"linear-gradient(135deg, #e53935 0%, #b71c1c 100%)"}},children:A?"Suppression...":`Supprimer (${i.length})`})]})]}),e.jsx(Ye,{anchorOrigin:{vertical:"top",horizontal:"right"},open:he,onClose:_,autoHideDuration:5e3,children:e.jsx(_e,{onClose:_,severity:Se,sx:{boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.05)",borderRadius:2,minWidth:300},children:e.jsx(t,{fontWeight:500,children:me})})})]})})};export{Ps as default};
